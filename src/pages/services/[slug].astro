---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { siteConfig } from '../../site.config';
import { services } from '../../data/services';
import { getServicePageContent } from '../../data/servicePages';
import Icon from '../../components/Icon.astro';

export function getStaticPaths() {
  return services.map((s) => ({ params: { slug: s.slug } }));
}

const { slug } = Astro.params;
const service = services.find((s) => s.slug === slug);
const content = getServicePageContent(slug!);

if (!service || !content) {
  return Astro.redirect('/');
}

const metaTitle = content.metaTitle;
const metaDescription = content.metaDescription;

const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: content.metaTitle.split('|')[0].trim(),
  description: content.metaDescription,
  provider: {
    '@type': 'LocalBusiness',
    name: siteConfig.name,
  },
  areaServed: siteConfig.areas.map((a) => ({ '@type': 'City', name: a })),
};

const faqBySlug: Record<string, { q: string; a: string }[]> = {
  'damp-condensation-surveys': [
    { q: 'What does an independent damp survey include?', a: 'An independent damp survey includes a site visit with moisture meters and thermal imaging where useful, identification of the cause (rising damp, penetrating damp or condensation), and a written report with moisture data and remedial recommendations. We do not recommend or sell treatments.' },
    { q: 'How much does a damp survey cost in London or Southampton?', a: 'Damp survey cost depends on property size and complexity. We give a fixed quote before the visit. Contact us for a no-obligation quote for Southampton, Winchester or London.' },
    { q: 'Do you do rising damp and condensation surveys?', a: 'Yes. We distinguish between rising damp, penetrating damp and condensation using moisture mapping and environmental logging, and provide clear cause analysis in the report.' },
  ],
  'indoor-air-quality-ventilation': [
    { q: 'What is included in an indoor air quality audit?', a: 'An IAQ audit typically includes CO₂, humidity and temperature monitoring, assessment of ventilation rates and extract performance, and—where relevant—VOC or particulate sampling. You receive a report with findings and recommendations.' },
    { q: 'Do you cover ventilation after insulation or retrofit?', a: 'Yes. We provide ventilation audits after retrofit and condensation-after-insulation investigations to balance airtightness with adequate ventilation.' },
  ],
};
const faqs = faqBySlug[slug!] || [];
const faqSchema = faqs.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: faqs.map((f) => ({
    '@type': 'Question',
    name: f.q,
    acceptedAnswer: { '@type': 'Answer', text: f.a },
  })),
} : null;
---
<BaseLayout title={metaTitle} description={metaDescription}>
  <script type="application/ld+json" set:html={JSON.stringify(serviceSchema)} />
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}

  <article class="mx-auto max-w-4xl px-4 py-12 sm:px-6">
    <header>
      <a href="/#services-heading" class="text-sm text-accent-blue hover:underline">← All services</a>
      <h1 class="mt-4 text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">
        {service.title}
      </h1>
      <p class="mt-2 text-lg text-gray-600">
        {service.shortDescription}
      </p>
    </header>

    <section class="mt-10" aria-labelledby="problem-heading">
      <h2 id="problem-heading" class="text-xl font-semibold text-gray-900">The problem</h2>
      <p class="mt-2 text-gray-700 leading-relaxed">
        {content.problem}
      </p>
    </section>

    <section class="mt-10" aria-labelledby="approach-heading">
      <h2 id="approach-heading" class="text-xl font-semibold text-gray-900">Our approach</h2>
      <p class="mt-2 text-gray-700 leading-relaxed">
        {content.approach}
      </p>
    </section>

    <section class="mt-10" aria-labelledby="deliverables-heading">
      <h2 id="deliverables-heading" class="text-xl font-semibold text-gray-900">Deliverables</h2>
      <ul class="mt-2 list-disc list-inside space-y-1 text-gray-700">
        {content.deliverables.map((d) => (
          <li>{d}</li>
        ))}
      </ul>
    </section>

    {faqs.length > 0 && (
    <section class="mt-10" aria-labelledby="faq-heading">
      <h2 id="faq-heading" class="text-xl font-semibold text-gray-900">Frequently asked questions</h2>
      <ul class="mt-4 space-y-4">
        {faqs.map((f) => (
          <li>
            <h3 class="font-medium text-gray-900">{f.q}</h3>
            <p class="mt-1 text-gray-700">{f.a}</p>
          </li>
        ))}
      </ul>
    </section>
    )}

    <section class="mt-10 rounded-xl border border-gray-200 bg-gray-50 p-6" aria-labelledby="where-heading">
      <h2 id="where-heading" class="text-xl font-semibold text-gray-900">Where we work</h2>
      <p class="mt-2 text-gray-700">
        We serve Southampton, Winchester, London and the South East—including Hampshire, Haringey, Lambeth, Islington, Camden and Southwark.
      </p>
      <ul class="mt-3 flex flex-wrap gap-2">
        <li><a href="/locations/southampton" class="text-accent-blue hover:underline">Southampton</a></li>
        <li><a href="/locations/winchester" class="text-accent-blue hover:underline">Winchester</a></li>
        <li><a href="/locations/london" class="text-accent-blue hover:underline">London</a></li>
        <li><a href="/locations/haringey" class="text-accent-blue hover:underline">Haringey</a></li>
        <li><a href="/locations/lambeth" class="text-accent-blue hover:underline">Lambeth</a></li>
        <li><a href="/locations/camden" class="text-accent-blue hover:underline">Camden</a></li>
        <li><a href="/locations/islington" class="text-accent-blue hover:underline">Islington</a></li>
      </ul>
    </section>

    <section class="mt-10 flex flex-wrap gap-4">
      <a href={siteConfig.bookingUrl} class="inline-flex rounded-lg bg-primary px-6 py-3 font-semibold text-white no-underline hover:bg-primary-hover">
        Book an inspection
      </a>
      <a href="/contact" class="inline-flex rounded-lg border-2 border-gray-300 px-6 py-3 font-semibold text-gray-700 no-underline hover:border-primary hover:text-primary">
        Request a report
      </a>
      <a href={`tel:${siteConfig.phone.replace(/\s/g, '')}`} class="inline-flex items-center gap-2 rounded-lg border-2 border-gray-300 px-6 py-3 font-semibold text-gray-700 no-underline hover:border-accent-blue hover:text-accent-blue">
        <Icon name="phone" class="h-5 w-5" />
        Call for advice
      </a>
    </section>
  </article>
</BaseLayout>
