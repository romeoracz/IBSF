---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { siteConfig } from '../../site.config';
import { forensicServices } from '../../data/forensicServices';
import { forensicServicePages } from '../../data/forensicServicePages';

export function getStaticPaths() {
  return forensicServices.map((s) => ({ params: { slug: s.slug } }));
}

const { slug } = Astro.params;
const service = forensicServices.find((s) => s.slug === slug);
const content = forensicServicePages[slug!];

if (!service || !content) {
  return Astro.redirect('/');
}

const related = content.relatedSlugs
  .map((rs) => forensicServices.find((s) => s.slug === rs))
  .filter(Boolean);

const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: content.title,
  description: content.metaDescription,
  provider: {
    '@type': 'ProfessionalService',
    name: siteConfig.name,
    alternateName: 'IBSF',
    telephone: siteConfig.phone,
    email: siteConfig.email,
    url: siteConfig.url,
    address: {
      '@type': 'PostalAddress',
      streetAddress: siteConfig.address.streetAddress,
      addressLocality: siteConfig.address.addressLocality,
      postalCode: siteConfig.address.postalCode,
      addressRegion: siteConfig.address.addressRegion,
      addressCountry: 'GB',
    },
  },
  areaServed: siteConfig.areas.map((a) => ({ '@type': 'City', name: a })),
  url: siteConfig.url + service.href,
  image: siteConfig.url + content.image,
};

const faqSchema = content.faqs.length > 0 ? {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: content.faqs.map((f) => ({
    '@type': 'Question',
    name: f.q,
    acceptedAnswer: { '@type': 'Answer', text: f.a },
  })),
} : null;
---
<BaseLayout title={content.metaTitle} description={content.metaDescription}>
  <script type="application/ld+json" set:html={JSON.stringify(serviceSchema)} />
  {faqSchema && <script type="application/ld+json" set:html={JSON.stringify(faqSchema)} />}

  <!-- Hero -->
  <section class="border-b border-gray-200 bg-white py-14 sm:py-20">
    <div class="mx-auto max-w-6xl px-4 sm:px-6">
      <a href="/services" class="text-sm text-navy-muted hover:text-navy">← All services</a>
      <div class="mt-6 grid gap-10 lg:grid-cols-[1fr,400px]">
        <div>
          <h1 class="font-serif text-3xl font-bold tracking-tight text-navy sm:text-4xl">
            {content.title}
          </h1>
          <p class="mt-4 text-lg text-navy-muted leading-relaxed">
            {content.heroSubtitle}
          </p>
          <div class="mt-8 flex flex-wrap gap-4">
            <a href="/contact" class="inline-flex rounded bg-navy px-6 py-3 text-base font-semibold text-white no-underline hover:bg-navy-light">
              Commission investigation
            </a>
            <a href={siteConfig.whatsapp} target="_blank" rel="noopener" class="inline-flex rounded border-2 border-navy px-6 py-3 text-base font-semibold text-navy no-underline hover:bg-navy hover:text-white">
              WhatsApp us
            </a>
          </div>
        </div>
        <div>
          <img src={content.image} alt={content.imageAlt} width="760" height="428" class="w-full rounded-lg" loading="eager" />
        </div>
      </div>
    </div>
  </section>

  <article class="mx-auto max-w-4xl px-4 py-12 sm:px-6">
    <!-- Problem -->
    <section class="mt-2" aria-labelledby="problem-heading">
      <h2 id="problem-heading" class="text-xl font-semibold text-navy">The problem</h2>
      <p class="mt-2 font-medium text-navy">{content.problem}</p>
      <p class="mt-3 text-navy-muted leading-relaxed">{content.problemDetail}</p>
    </section>

    <!-- Risk -->
    <section class="mt-10" aria-labelledby="risk-heading">
      <h2 id="risk-heading" class="text-xl font-semibold text-navy">The risk</h2>
      <p class="mt-2 font-medium text-navy">{content.risk}</p>
      <p class="mt-3 text-navy-muted leading-relaxed">{content.riskDetail}</p>
    </section>

    <!-- Investigation -->
    <section class="mt-10" aria-labelledby="investigation-heading">
      <h2 id="investigation-heading" class="text-xl font-semibold text-navy">Our investigation</h2>
      <p class="mt-2 text-navy-muted leading-relaxed">{content.investigation}</p>
      <ol class="mt-4 list-decimal list-inside space-y-2 text-navy-muted">
        {content.investigationSteps.map((step) => (
          <li>{step}</li>
        ))}
      </ol>
    </section>

    <!-- Findings -->
    <section class="mt-10" aria-labelledby="findings-heading">
      <h2 id="findings-heading" class="text-xl font-semibold text-navy">Findings</h2>
      <p class="mt-2 text-navy-muted leading-relaxed">{content.findings}</p>
    </section>

    <!-- Report output -->
    <section class="mt-10 rounded-lg border border-gray-200 bg-gray-50 p-6" aria-labelledby="report-heading">
      <h2 id="report-heading" class="text-lg font-semibold text-navy">What the report delivers</h2>
      <ul class="mt-3 grid gap-2 sm:grid-cols-2">
        {content.reportOutput.map((item) => (
          <li class="flex gap-2 text-sm text-navy-muted">
            <span class="mt-0.5 text-primary">✓</span>
            <span>{item}</span>
          </li>
        ))}
      </ul>
    </section>

    <!-- Who commissions -->
    <section class="mt-10" aria-labelledby="who-heading">
      <h2 id="who-heading" class="text-xl font-semibold text-navy">Who commissions this investigation?</h2>
      <div class="mt-4 grid gap-4 sm:grid-cols-2">
        {content.whoCommissions.map((w) => (
          <div class="rounded-lg border border-gray-200 bg-white p-4">
            <h3 class="font-semibold text-navy">{w.label}</h3>
            <p class="mt-1 text-sm text-navy-muted">{w.detail}</p>
          </div>
        ))}
      </div>
    </section>

    <!-- FAQs -->
    {content.faqs.length > 0 && (
      <section class="mt-10" aria-labelledby="faq-heading">
        <h2 id="faq-heading" class="text-xl font-semibold text-navy">Frequently asked questions</h2>
        <dl class="mt-4 space-y-5">
          {content.faqs.map((f) => (
            <div class="border-b border-gray-200 pb-4">
              <dt class="font-semibold text-navy">{f.q}</dt>
              <dd class="mt-1 text-navy-muted leading-relaxed">{f.a}</dd>
            </div>
          ))}
        </dl>
      </section>
    )}

    <!-- Trust strip -->
    <div class="mt-10 flex flex-wrap items-center gap-6 border-y border-gray-200 py-6 text-sm font-medium text-navy-muted">
      <span>Independent & non-remedial</span>
      <span>PhD-level expertise</span>
      <span>Professional indemnity insured</span>
      <span>Instrument-verified</span>
    </div>

    <!-- Locations & keywords -->
    <section class="mt-10 rounded-lg border border-gray-200 bg-gray-50 p-6">
      <h2 class="text-lg font-semibold text-navy">Where we work</h2>
      <p class="mt-2 text-sm text-navy-muted">{content.locationKeywords}</p>
      <ul class="mt-3 flex flex-wrap gap-3">
        <li><a href="/southampton" class="text-sm font-medium text-primary hover:underline">Southampton</a></li>
        <li><a href="/winchester" class="text-sm font-medium text-primary hover:underline">Winchester</a></li>
        <li><a href="/london" class="text-sm font-medium text-primary hover:underline">London</a></li>
      </ul>
    </section>

    <!-- Related services -->
    {related.length > 0 && (
      <section class="mt-10">
        <h2 class="text-lg font-semibold text-navy">Related investigations</h2>
        <ul class="mt-4 grid gap-3 sm:grid-cols-3">
          {related.map((r) => (
            <li>
              <a href={r!.href} class="block rounded-lg border border-gray-200 bg-white p-4 text-sm no-underline transition hover:border-navy hover:shadow-md">
                <span class="font-semibold text-navy">{r!.title}</span>
              </a>
            </li>
          ))}
        </ul>
      </section>
    )}

    <!-- CTA -->
    <section class="mt-12 rounded-lg bg-navy p-8 text-center">
      <h2 class="font-serif text-xl font-bold text-white sm:text-2xl">Commission this investigation</h2>
      <p class="mt-2 text-sm text-gray-300">Request an initial case review. We respond to serious enquiries promptly.</p>
      <div class="mt-6 flex flex-wrap justify-center gap-4">
        <a href="/contact" class="inline-flex rounded bg-white px-6 py-3 font-semibold text-navy no-underline hover:bg-gray-100">Commission Investigation</a>
        <a href={siteConfig.whatsapp} target="_blank" rel="noopener" class="inline-flex rounded border-2 border-white px-6 py-3 font-semibold text-white no-underline hover:bg-white hover:text-navy">WhatsApp</a>
        <a href={`tel:${siteConfig.phone.replace(/\s/g, '')}`} class="inline-flex rounded border-2 border-white px-6 py-3 font-semibold text-white no-underline hover:bg-white hover:text-navy">Call {siteConfig.phone}</a>
      </div>
    </section>

    <p class="mt-8 border-t border-gray-200 pt-6 text-sm text-navy-muted">
      <strong>NAP:</strong> {siteConfig.name}, {siteConfig.address.full}. Tel: {siteConfig.phone}. Email: {siteConfig.email}.
    </p>
  </article>
</BaseLayout>
